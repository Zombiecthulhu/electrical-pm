// Prisma Schema for Electrical Construction Project Management System
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id            String    @id @default(uuid()) @db.Uuid
  email         String    @unique
  password_hash String
  role          UserRole  @default(FIELD_WORKER)
  first_name    String
  last_name     String
  phone         String?
  avatar_url    String?
  is_active     Boolean   @default(true)
  last_login    DateTime? @db.Timestamptz(6)
  created_at    DateTime  @default(now()) @db.Timestamptz(6)
  updated_at    DateTime  @updatedAt @db.Timestamptz(6)
  deleted_at    DateTime? @db.Timestamptz(6)

  // Relations
  created_projects Project[]       @relation("CreatedProjects")
  updated_projects Project[]       @relation("UpdatedProjects")
  project_members  ProjectMember[]
  created_clients  Client[]        @relation("CreatedClients")
  updated_clients  Client[]        @relation("UpdatedClients")
  uploaded_files   File[]
  daily_logs       DailyLog[]
  created_quotes   Quote[]         @relation("CreatedQuotes")
  updated_quotes   Quote[]         @relation("UpdatedQuotes")

  @@index([email])
  @@index([role])
  @@index([is_active])
  @@index([created_at])
  @@index([deleted_at])
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN
  PROJECT_MANAGER
  FIELD_SUPERVISOR
  OFFICE_ADMIN
  FIELD_WORKER
  CLIENT_READ_ONLY
}

// Client Management
model Client {
  id         String     @id @default(uuid()) @db.Uuid
  name       String
  type       ClientType
  address    String?
  phone      String?
  email      String?
  website    String?
  tax_id     String?
  notes      String?
  created_by String     @db.Uuid
  updated_by String     @db.Uuid
  created_at DateTime   @default(now()) @db.Timestamptz(6)
  updated_at DateTime   @updatedAt @db.Timestamptz(6)
  deleted_at DateTime?  @db.Timestamptz(6)

  // Relations
  creator  User            @relation("CreatedClients", fields: [created_by], references: [id])
  updater  User            @relation("UpdatedClients", fields: [updated_by], references: [id])
  projects Project[]
  quotes   Quote[]
  contacts ClientContact[]

  @@index([name])
  @@index([type])
  @@index([created_by])
  @@index([created_at])
  @@index([deleted_at])
  @@map("clients")
}

enum ClientType {
  GENERAL_CONTRACTOR
  DEVELOPER
  HOMEOWNER
  COMMERCIAL
  OTHER
}

model ClientContact {
  id         String   @id @default(uuid()) @db.Uuid
  client_id  String   @db.Uuid
  name       String
  title      String?
  phone      String?
  email      String?
  is_primary Boolean  @default(false)
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  client   Client    @relation(fields: [client_id], references: [id], onDelete: Cascade)
  projects Project[]

  @@index([client_id])
  @@index([is_primary])
  @@map("client_contacts")
}

// Project Management
model Project {
  id                 String        @id @default(uuid()) @db.Uuid
  name               String
  project_number     String        @unique
  client_id          String        @db.Uuid
  contact_id         String?       @db.Uuid
  status             ProjectStatus @default(QUOTED)
  type               ProjectType
  billing_type       BillingType @default(TIME_AND_MATERIALS)
  location           String?
  address            String?
  latitude           Float?
  longitude          Float?
  start_date         DateTime?     @db.Timestamptz(6)
  end_date           DateTime?     @db.Timestamptz(6)
  estimated_end_date DateTime?     @db.Timestamptz(6)
  actual_end_date    DateTime?     @db.Timestamptz(6)
  budget             Decimal?      @db.Decimal(12, 2)
  actual_cost        Decimal?      @db.Decimal(12, 2)
  description        String?
  created_by         String        @db.Uuid
  updated_by         String        @db.Uuid
  created_at         DateTime      @default(now()) @db.Timestamptz(6)
  updated_at         DateTime      @updatedAt @db.Timestamptz(6)
  deleted_at         DateTime?     @db.Timestamptz(6)

  // Relations
  client     Client           @relation(fields: [client_id], references: [id])
  contact    ClientContact?   @relation(fields: [contact_id], references: [id])
  creator    User             @relation("CreatedProjects", fields: [created_by], references: [id])
  updater    User             @relation("UpdatedProjects", fields: [updated_by], references: [id])
  members    ProjectMember[]
  files      File[]
  daily_logs DailyLog[]
  expenses   ProjectExpense[]

  @@index([project_number])
  @@index([client_id])
  @@index([status])
  @@index([type])
  @@index([billing_type])
  @@index([created_by])
  @@index([start_date])
  @@index([end_date])
  @@index([budget])
  @@index([actual_cost])
  @@index([created_at])
  @@index([deleted_at])
  @@map("projects")
}

enum ProjectStatus {
  QUOTED
  AWARDED
  IN_PROGRESS
  INSPECTION
  COMPLETE
  ON_HOLD
  CANCELLED
}

enum ProjectType {
  COMMERCIAL
  RESIDENTIAL
  INDUSTRIAL
  MAINTENANCE
  OTHER
}

enum BillingType {
  TIME_AND_MATERIALS
  LUMP_SUM
  SERVICE_CALL
}

model ProjectMember {
  id          String   @id @default(uuid()) @db.Uuid
  project_id  String   @db.Uuid
  user_id     String   @db.Uuid
  role        String
  assigned_at DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([project_id, user_id])
  @@index([project_id])
  @@index([user_id])
  @@map("project_members")
}

model ProjectExpense {
  id          String   @id @default(uuid()) @db.Uuid
  project_id  String   @db.Uuid
  description String
  amount      Decimal  @db.Decimal(10, 2)
  category    String
  date        DateTime @db.Timestamptz(6)
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@index([project_id])
  @@index([date])
  @@index([category])
  @@map("project_expenses")
}

// File Management
model File {
  id                String       @id @default(uuid()) @db.Uuid
  storage_path      String
  original_filename String
  mime_type         String
  file_size         Int
  checksum          String?
  category          FileCategory
  project_id        String?      @db.Uuid
  daily_log_id      String?      @db.Uuid
  uploaded_by       String       @db.Uuid
  uploaded_at       DateTime     @default(now()) @db.Timestamptz(6)
  version_number    Int          @default(1)
  parent_file_id    String?      @db.Uuid
  tags              String[]
  description       String?
  
  // Photo-specific fields
  thumbnail_path    String?
  width             Int?
  height            Int?
  exif_data         Json?
  
  // Document-specific fields
  page_count        Int?
  
  // Organization fields
  folder_path       String?
  is_favorite       Boolean      @default(false)
  
  // Metadata
  created_at        DateTime     @default(now()) @db.Timestamptz(6)
  updated_at        DateTime     @updatedAt @db.Timestamptz(6)
  deleted_at        DateTime?    @db.Timestamptz(6)

  // Relations
  project     Project?  @relation(fields: [project_id], references: [id])
  daily_log   DailyLog? @relation(fields: [daily_log_id], references: [id])
  uploader    User      @relation(fields: [uploaded_by], references: [id])
  parent_file File?     @relation("FileVersions", fields: [parent_file_id], references: [id])
  child_files File[]    @relation("FileVersions")

  @@index([project_id])
  @@index([daily_log_id])
  @@index([uploaded_by])
  @@index([category])
  @@index([uploaded_at])
  @@index([deleted_at])
  @@index([is_favorite])
  @@index([folder_path])
  @@map("files")
}

enum FileCategory {
  DOCUMENT
  PHOTO
  PLAN
  SPEC
  PERMIT
  CONTRACT
  INVOICE
  RECEIPT
  REPORT
  OTHER
}

// Daily Logs
model DailyLog {
  id              String   @id @default(uuid()) @db.Uuid
  project_id      String   @db.Uuid
  date            DateTime @db.Timestamptz(6)
  weather         String?
  crew_members    Json?
  hours_worked    Json?
  work_performed  String
  materials_used  Json?
  equipment_used  String?
  issues          String?
  inspector_visit String?
  created_by      String   @db.Uuid
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  project Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  creator User    @relation(fields: [created_by], references: [id])
  files   File[]

  @@index([project_id])
  @@index([date])
  @@index([created_by])
  @@index([created_at])
  @@map("daily_logs")
}

// Quote/Bid Management
model Quote {
  id           String      @id @default(uuid()) @db.Uuid
  quote_number String      @unique
  client_id    String      @db.Uuid
  project_name String
  status       QuoteStatus @default(DRAFT)
  line_items   Json
  subtotal     Decimal     @db.Decimal(12, 2)
  tax          Decimal?    @db.Decimal(12, 2)
  total        Decimal     @db.Decimal(12, 2)
  notes        String?
  valid_until  DateTime?   @db.Timestamptz(6)
  created_by   String      @db.Uuid
  updated_by   String      @db.Uuid
  created_at   DateTime    @default(now()) @db.Timestamptz(6)
  updated_at   DateTime    @updatedAt @db.Timestamptz(6)

  // Relations
  client  Client @relation(fields: [client_id], references: [id])
  creator User   @relation("CreatedQuotes", fields: [created_by], references: [id])
  updater User   @relation("UpdatedQuotes", fields: [updated_by], references: [id])

  @@index([quote_number])
  @@index([client_id])
  @@index([status])
  @@index([created_by])
  @@index([created_at])
  @@map("quotes")
}

enum QuoteStatus {
  DRAFT
  SENT
  PENDING
  ACCEPTED
  REJECTED
}
